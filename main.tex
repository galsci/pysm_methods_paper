\documentclass[twocolumn]{aastex631}
\bibliographystyle{aasjournal}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{mathtools}
\usepackage{url}
\usepackage{booktabs} 

\newcommand{\done}{{\tt d1}}
\newcommand{\dnine}{{\tt d9}}
\newcommand{\deleven}{{\tt d11}}

\usepackage{color}
\newcommand{\bsh}[1]{\textcolor{red}{(BSH: #1)}}
\newcommand{\giuse}[1]{\textcolor{orange}{(GP: #1)}}
\newcommand{\sg}[1]{\textcolor{teal}{(SG: #1)}}
\newcommand{\mr}[1]{\textcolor{magenta}{#1}}
\providecommand{\sorthelp}[1]{}

\begin{document}

\title{The Python Sky Model 3.1: \\Improved Models of Galactic Dust and Synchrotron Emission}
\author{PanEx PySM Team}
\date{\today}

\begin{abstract}
    Lorem ipsum
\end{abstract}

\section{Introduction}
%writing: Brandon, Julian (multi-experiment collab), Susan + others

One of the principal challenges for current and future cosmic microwave background (CMB) polarization experiments is mitigating contaminating emission from the Galaxy. Polarized Galactic emission is brighter than current upper limits on a primordial B-mode signal at all frequencies, even in particularly clean patches of high Galactic latitude sky, while future surveys targeting wide areas ($f_{\rm sky} \gtrsim 50\%$ for cosmological analyses) will measure polarized Galactic emission more than an order of magnitude brighter. Thus understanding the potential complexities of Galactic emission and designing analyses robust to them is of paramount importance for constraining the physics of the early Universe.

To this end, tools have been developed to simulate full-sky, multi-frequency realizations of Galactic emission drawing both on data-driven constraints and theoretical models. The Planck Sky Model \citep[PSM;][]{delabrouille2012} was originally put together to develop data analysis tools for the Planck mission, using pre-existing data sets. It evolved throughout the Planck mission timeline to gradually include Planck observations and adjust to Planck data analysis requirements, and has been widely used in various data challenges and/or for planning future CMB experiments \textcolor{red}{[JD: Should we cite a few examples here, or leave it at that?]}. Building on the PSM, the Python Sky Model \citep[PySM;][]{Thorne:2017} provides a Pythonic interface to expanded classes of foreground models. PySM has been widely used for both data analysis and forecasting \citep[e.g.,][]{CCAT-Primecollaboration:2021,Hensley:2021}. %As the sensitivity of CMB experiments is improved, 

In this work, we introduce several important improvements to the PySM software. First, we update foreground emission templates at large angular scales to agree with current best determinations. Second, we develop and implement a new framework for simulating stochastic realizations of small-scale emission, allowing users to generate many realizations of the Galactic microwave sky with the same statistical properties but different small-scale morphologies. We employ this framework to include small scale fluctuations in maps of both foreground amplitudes as well as spectral parameters, such as dust temperature. Third, we implement the ``layer model'' of \citet{Martinez-Solaeche:2018} (henceforth the ``MKD'' model) in which dust emission is modeled from the sum of up to six discrete layers along the line of sight. This results in sky simulations having non-zero line-of-sight decorrelation, a phenomenon recently detected in Planck data in which the dust polarization angle can change with frequency \citep{Pelgrims:2021}. 

The models developed here follow several general principles, in line with the ethos of previous generations of Galactic emission models. The models are explicitly data-based on scales and frequencies where the Galactic emission is well-measured: we use the best available data to the extent possible. Where we do not have high-fidelity measurements, we have some freedom on the ultimate characteristics of our synthetic Galactic emission. We strive to be guided by two principles: first, we take a ``physics-first" approach to the problem wherever possible, preferring to be guided by our current understanding of ISM physics. 

% [maybe Gauss-Legendre]

We define three sets of Galactic foreground models that are both driven by the existing data where they are unambiguous and span a range of complexities (labeled low, medium, and high) in their approach to modeling emission in the parameter space where it is not well-constrained by data. This suite will enable individual experiments to optimize their designs over our current understanding of the Galactic foreground sky, and will also support comparative and especially combined analyses of multiple experiments. 
%, for example analyzing CMB-S4 data together with that of the precursor South Pole and/or Simons Observatories, or using CMB-S4 high resolution data to help delens LiteBIRD and LiteBIRD high frequency data to help remove dust from CMB-S4.

We organize the paper as follows: in Section~\ref{sec:methods}, we give an overview of how Galactic emission models are implemented in PySM; in Section~\ref{sec:templates}, we describe the new data-driven templates used to model emission at large angular scales; in Section~\ref{sec:small_scales}, we present our methodology for generating stochastic simulations of small-scale emission using the polarization fraction tensor formalism; in Section~\ref{sec:layers}, we describe the implementation of the MKD model in PySM; in Section~\ref{sec:validation}, we present a collection of validation metrics for the new models; in Section \ref{sec:modelsuite}, we present our proposed triplet of models that span a range of complexity; in Section~\ref{sec:discussion}, we discuss current limitations and future directions for development; and we conclude in Section~\ref{sec:summary}.

\section{Methods Overview} \label{sec:methods}
% writing: Andrea + others

\begin{enumerate}
    \item Recap of PySM code at more technical level than Introduction: objectives, methods
    \item Motivate aims of this paper: improved templates, generating small scales on the fly, and incorporating 3D effects
\end{enumerate}

\textbf{Andrea: technical details about PySM 3}

The groundwork that allowed the implementation of this new generation of Galactic models started in 2019 with the rewrite of PySM and its release as PySM~3 \citep[see][for details]{Zonca:2021}.

The most stringent requirement of models at high resolution is the sheer size of the templates: maps at a pixel size of 0.4 arcminutes ($N_{side}=8192$) occupy ~3\,GB per component in single precision and are 256 times larger than the original PySM~2 maps. The problem of distribution has been solved by hosting all the input templates at NERSC \footnote{\url{https://portal.nersc.gov/project/cmb/pysm-data}}, with templates downloaded and cached by PySM as needed using the facilities included in \texttt{astropy.data} \citep{AstropyCollaboration:2013, AstropyCollaboration:2018}. Moreover, all the members of the CMB community using NERSC for computing are able to directly access the same folders locally. The second issue is memory usage, PySM 3 leverages \texttt{numba} \citep{numba:2015} to compile Python on-the-fly to machine code so that the evaluation and bandpass integration of each model avoids the temporary arrays allocated by \texttt{numpy} and reduces memory consumption at least by a factor of two. Moreover, \texttt{numba} supports multi-threading so it can make use of all the cores available in the system.

Thanks to the above-mentioned improvements, we were able to create foreground models with a resolution up to $N_{side}=8192$ keeping the disk, memory and CPU requirements manageable. 

{\bf needs some motivational text on improvements, especially stochasticity but also templates}

\input{templates}
\input{small_scales}

\section{Layer Model} \label{sec:layers}
%writing: jacques

Evidence for variation of Galactic foreground emission laws as a function of frequency across the sky also implies that emission laws must vary along the line of sight. As a consequence, we anticipate that dust emission, if locally matching a modified blackbody in the form of equation \ref{eq:dust-emission-law}, is seen by an observer as a superposition (an integral along the line of sight) of modified blackbodies -- which is not a modified blackbody. In addition, if along the line of sight different line elements emit polarized radiation with different polarization angles, the frequency scaling should vary between $I$, $Q$ and $U$. To model this complexity, a multilayer dust emission model based on an implementation of the approach of \cite{Martinez-Solaeche:2018} in the PSM software (version 2.3.3) has been implemented in PysM 3.

The PSM has been run to produce six maps of dust emission at 353~GHz (intensity and polarization, for a total of 18 Healpix maps at {\tt nside=2048}), and six maps of dust spectral index $\beta_d$ and dust temperature $T_d$, also at {\tt nside=2048}, following the approach described in \cite{Martinez-Solaeche:2018}. The PySM software uses these maps as inputs, and generates the dust Stokes parameters maps as:
\begin{equation}
    S_\nu(p) = \sum_{i=1}^6 S^i_{\nu_{\rm ref}}(p)
    \left( \frac{\nu}{\nu_{\rm ref}} \right)^{\beta^i_d(p)}
    \frac{B_\nu(T^i_d(p))}{B_{\nu_{\rm ref}}(T^i_d(p))},
\end{equation}
where $S_\nu(p)$ stands for any of the three Stokes parameters of interest, $I$, $Q$ and $U$, at frequency $\nu$ and in pixel $p$, and superscripts $i$ indicate the layer, from 1 to 6.

In the implementation used here, the 353~GHz templates for the six emission layers are slightly different from those of \cite{Martinez-Solaeche:2018} as we employ more recent Planck data products. Large scale polarized emission maps are the GNILC maps obtained in \cite{planck2016-l04} using the method developed by \cite{2011MNRAS.418..467R}. These are complemented by small scale realizations with scale dependence matching the $I$, $E$ and $B$ dust spectra measured in \cite{planck2016-l11A}, modulated by the large scale local intensity and polarized intensity level. This process filters some of the real small scale power in dust intensity and polarization maps, replacing it with random fluctuations, and thus does not quite reproduce the non-Gaussian and non-stationary properties of real dust emission. Improving the generation of small scale fluctuations is left to future work.

% \item Methodology, especially the connection between MKD and what we implement in PySM. What capabilities of PySM can we exploit to extend MKD?
%  \item Comments on any numerical trickiness, e.g., p > 1

\section{Map Validation} \label{sec:validation}
\begin{enumerate}
    \item Define suite of tests
    \item Compare models in interesting spaces, e.g., decorrelation, EE/BB
    \item Zoom in on B/K patch, other regions
    \item Non-gaussianity of polarization fraction tensor formalism
    \item Susan's student's plot of maps x galaxy catalogs (a la Chiang and Menard) to demonstrate CIB mitigation
\end{enumerate}

\textbf{Ben:} In this section we validate the foreground model developed in Section~\ref{sec:small_scales}. \sg{In Section~\ref{sec:sync_validation} we compare the power spectra of different synchrotron models with BeyondPlanck synchrotron map for temperature, and LFI 30 GHz for polarization. We find a reasonable agreement between the data and our models for different fraction of the galactic synchrotron signal masked.} In Section~\ref{sec:dust_validation} we will demonstrate that the two-point statistics of the stochastic small scales are properly modulated for different regions of sky defined by Galactic masks of varying size. We will also assess the properties of our dust model in the small patch of sky observed by the BICEP / Keck telescopes and the South Pole Telescope. In Section~\ref{sec:nongaussianity}, we will assess the level of non-Gaussianity introduced by the log polarization tensor formalism, and compare this to the case of a purely Gaussian small scale model which has been modulated by a Galactic template. 

\subsection{Synchrotron validation} \label{sec:sync_validation}
\textbf{Shamik:} In this section we detail the validation of the new synchrotron models by comparing them with BeyondPlanck synchrotron map for temperature, and LFI 30 GHz observations for polarization. We compare the model with data at map level and by computing the power spectra. For validating the PySM synchrotron temperature models, we use the synchrotron map from the BeyondPlanck re-analysis of Planck LFI data \citep{2022arXiv220108188A}. The BeyondPlanck release 1 synchrotron map is at a reference frequency of 30\,GHz at $2^\circ$ angular resolution. We produce single frequency temperature maps for the different synchrotron models at 30\,GHz and smoothed with a Gaussian beam with FWHM = $2^\circ$.

In case of the synchrotron polarization, we are comparing the models with band integrated observations. So, we compute bandpass integrated maps of the different synchrotron models. For this purpose we use the average LFI 30\,GHz RIMO transmission \citep{planck2014-a03}. The bandpass integrated maps are further smoothed with Gaussian beams of 33.1 arcmin beams to produce model maps at native resolutions of the LFI 30 GHz data. The observed power spectra are computed by taking a cross spectra between A and B splits of the NPIPE (PR4) 30 GHz maps \citep{planck2020-LVII}.

%\subsubsection{Galactic masks}
The polarized synchrotron power spectra validation is performed on the full sky and with sky masks with 70\% and 50\% sky fractions. To produce the 70\% and 50\% masks we use the LFI 30\,GHz map of polarized intensity, smoothed with a Gaussian beam of $2^\circ$ FWHM, and masking pixels above 17 and 10 $\mu{\rm K}_{\rm CMB}$, respectively. These masks are shown in Figure \ref{fig:sync_masks}. We apodized these masks with a $2^\circ$ cosine apodization.
\begin{figure}
    \centering
    \includegraphics[width=0.46\textwidth]{figures/sync_galactic_mask.png}
    \caption{Figure showing the two different Galactic masks used for the synchrotron validation. The yellow region is included by the 50\% sky mask, while the 70\% mask additionally includes the pink region.}
    \label{fig:sync_masks}
\end{figure}

We use HEALPix \footnote{https://healpix.sourceforge.io} \texttt{anafast} function \citep{2005ApJ...622..759G, 2019JOSS....4.1298Z}  to compute the power spectra for the model and observation maps. For the polarization analysis, both the model and the LFI maps are additionally masked with an apodized polarized point source mask. We do not use a pseudo-$C_\ell$ estimator as the synchrotron signal is not statistically isotropic, and we correct for the partial sky by naively dividing by an $f_{\rm sky}$ factor.

\begin{figure}
    \centering
    \includegraphics[width=0.48\textwidth]{figures/Dlcomp_PySM3-4b7_s5_vs_BPnLFI30_BPI.png}
    \caption{Figure showing comparison of power spectra of the PySM s5 model with observation on different sky fractions. The spectra obtained for models s4, s6 and s7 are similar so we don't show them here. The $TT$ power spectrum comparison is done with synchrotron maps from BeyondPlanck release 1. The $EE$ and $BB$ power spectra is compared with NPIPE LFI 30\,GHz map. The LFI 30\,GHz spectra are computed as a cross spectra between the NPIPE splits A and B.}
    \label{fig:Dl_sync_galmask}
\end{figure}

The $TT$, $EE$ and $BB$ power spectra comparisons, for model s5, are shown in Figure~\ref{fig:Dl_sync_galmask}. The comparison for models s4, s6 and s7 have nearly identical results. The $TT$ power spectra for masked skies show excellent agreement with the BeyondPlanck synchrotron temperature power spectra. However, there is poor agreement for the full sky power spectra. On the full sky most of the spectra is dominated by what happens in the Galactic plane, which for observational data is contaminated by free-free and anomalous microwave emission (AME). Despite the BeyondPlanck component separation, the synchrotron power in the brightest sky regions are likely to have some residual contamination and associated uncertainty. So, it is reasonable to argue that for synchrotron temperature there is excellent agreement for all but the brightest parts of the sky, where the comparison is harder to make at 30\,GHz. For polarization we find reasonable agreement at $\ell \lesssim 100$. For $\ell > 100$ the PySM synchrotron models typically have less power than the data. However, an important caveat is that despite the point source masking, there is some residual radio point source contribution to this power in the LFI maps.

\begin{figure}
    \centering
    \includegraphics[width=0.49\textwidth]{figures/Dlcomp_PySM3-4b8_BKpatch.png}
    \caption{Figure showing comparison of power spectra in the BICEP/Keck patch for the new PySM synchrotron models s4, s5 and s7 with old synchrotron model s1 and the limits on the synchrotron power obtained in BICEP/Keck 2018 \citep{Ade:2021} at the reference frequency of 23 GHz. The blue line shows the BICEP/Keck 2018 maximum likelihood model for synchrotron with $A_s=0.6 \mu {\rm K}^2$, $\alpha_s=0$. The red arrow indicates the BICEP/Keck 95\% confidence upper limit on $A_s<1.4 \mu {\rm K}^2$ after marginalizing over $-1<\alpha_s<0$ at $\ell=80$. Note that the PySM synchrotron model s4, s5 and s7 have identical spectra.}
    \label{fig:Dl_sync_BK}
\end{figure}

\subsubsection{BICEP / Keck patch}
The cleanest patch of sky in the southern hemisphere is particularly important for ongoing and future CMB experiments that target measurement of the primordial CMB B-modes. We focus on the small clean patch of sky that is targeted for the BICEP/Keck experiment for their constraints on the tensor-to-scalar ratio. This overlaps with the tentative sky patch that will be targeted by the CMB-S4 experiment for their primordial B-mode search. In their 2021 analysis the BICEP/Keck team placed a upper limit of $A_s<1.4 \mu{\rm K}^2$ at a pivot frequency of 23\,GHz with $\beta_s=-3.1$ after marginalizing over the range $-1<\alpha_s<0$ \citep{Ade:2021}. The BICEP/Keck maximum likelihood model for the synchrotron spectra is parameterized by $A_s=0.6 \mu{\rm K}^2$, $\beta_s=-3.0$ and $\alpha_s=0$. In Figure~\ref{fig:Dl_sync_BK}, we compare these two sets of constraints from the BICEP/Keck 2018 results with the new PySM synchrotron models s4, s5 and s7. We also plot the old PySM s1 synchrotron model to show how the synchrotron model has changed in this patch of interest.

The new synchrotron models, s4, s5 and s7, have more power in the BICEP/Keck patch when compared to the old s1 synchrotron model. The latest BICEP/Keck results only has weak detection of synchrotron. We find that both the old and new PySM models are consistent with the BICEP/Keck upper limit on the synchrotron power. However, the BICEP/Keck maximum likelihood model for synchrotron has a better agreement with the new synchrotron models s4, s5 and s7 than with the old s1 synchrotron model. Thus, the new small scale generation in the synchrotron models s4, s5, and s7 increases the synchrotron power in the BICEP/Keck patch and is in better agreement with the constraints from the latest BICEP/Keck results.

\subsection{Dust validation} \label{sec:dust_validation}

\textbf{Ben:} In this section we calculate the power spectra of the dust template described in Section~\ref{sec:small_scales} using a variety of Galactic masks derived for the analysis of Planck data. We also present power spectra calculated on the region of sky observed by the BICEP Array and SPT-3G experiments. This latter case will assess how the small scale model performs in small areas of high latitude sky, which are vital for future constraints on the tensor-to-scalar ratio. Primarily, we will demonstrate that the spatial modulation of the small-scale realizations does not add too much foreground power in areas of high latitude sky, which has been a criticism of previous PySM models. 

All power spectra in this section are computed using the {\tt NaMaster} code \citep{Alonso:2019}. 

\subsubsection{Planck Galactic masks} \label{sec:galactic_spectra}

\textbf{Ben:} In this section we present power spectra computed on Galactic masks of varying sizes. We define a set of Galactic masks starting from the unapodized Galactic masks\footnote{\texttt{HFI\_Mask\_GalPlane-apo0\_2048\_R2.00.fits} distributed \url{https://pla.esac.esa.int}} by the Planck collaboration via the Planck Legacy Archive. There are eight masks in total, leaving between 20\% and 99\% of the sky available for analysis. We apodize each mask with a cosine taper of characteristic length $2^\circ$ resulting in nine masks: \texttt{GAL015}, \texttt{GAL034}, \texttt{GAL052}, \texttt{GAL062}, \texttt{GAL072}, \texttt{GAL082}, \texttt{GAL092}, \texttt{GAL096}, where the number indicates the percentage of the sky left for analysis, i.e., $100 f_{\rm sky}$.  

In Figure~\ref{fig:spectra_by_field} we show the $TT$, $EE$, and $BB$ power spectra of the \dnine{} model, and of the GNILC maps from which the \dnine{} model was derived, computed on four of the Galactic masks described above.

\begin{figure}
    \centering
    \includegraphics{paper_spectra_by_field_NSIDE2048.pdf}
    \caption{This figure compares the power spectra of the \dnine{} model (solid lines) and the input GNILC map (dashed lines) when computed on the \texttt{GAL015}, \texttt{GAL034}, \texttt{GAL052}, and \texttt{GAL072} Galactic masks.}
    \label{fig:spectra_by_field}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.48\textwidth]{figures/smallfield_power.pdf}
    \caption{The binned $BB$ power spectra from the 353~GHz NPIPE half-ring split maps and dust model maps \texttt{d9} and \texttt{d12}. The model maps are integrated with a 353~GHz delta bandpass and the NPIPE data maps are color-corrected (i.e. scaled by a factor of 0.92) to the same single frequency. The dashed lines indicate the best-fit of the fixed-index power law ($\mathcal{D}_\ell^{BB} = A^{BB} \big( l/80 \big)^{\alpha^{BB}+2}$ where $\alpha^{BB} = -2.42$) to the NPIPE data points, which is largely driven by the first two band powers. Note that we only show the \texttt{d9} results as this model is identical to \texttt{d10} at 353~GHz.}
    \label{fig:smallfield_power}
\end{figure}

\subsubsection{Small Field Power Analysis} 

\textbf{Kenny:} To compare the small-scale performances of the latest PySM dust models \texttt{d9}, \texttt{d10} and \texttt{d12} with real data, we mainly follow the analysis method described in \cite{planck2014-XXX} to examine the model behaviors. We first use a HEALPix grid with $\texttt{nside} = 8$ to divide the full sky into 768 patches. At the center of each patch, we create a 400-square-degree circular mask with its edge tapered by a $2^\circ$ FWHM Gaussian (resulting in $f_{\rm sky} \approx 0.008$), and apply such a mask to the mean-subtracted dust model and NPIPE half-ring split maps at 353~GHz. We then use \texttt{anafast} to compute the binned $BB$ auto-spectra of the masked model maps at $\ell = 55,90,135,190,255,330$ with $\Delta \ell = 30$, and scale them to be the full-sky $\mathcal{D}_\ell^{BB}$ by dividing the apodization mask integral squared. For the masked NPIPE data maps, we instead compute cross-spectrum from the two split maps to minimize the noise correlation. The representative results from two selected circular fields at $|b| > 30^\circ$ of the northern and southern Galactic hemispheres are shown in Fig.~\ref{fig:smallfield_power}. (\textbf{Kenny:} this analysis uses anafast - contradicts with the NaMaster stated above?)

We would like to explore whether the PySM models can reproduce the dust $BB$ power spectrum's amplitude and steepness over $\ell$ in reality, especially in those high Galactic latitude small fields. We therefore compute the low-$\ell$ averaged $\mathcal{D}_\ell^{BB}$ (over $\ell = 55, 90$) and the high-$\ell$ averaged $\mathcal{D}_\ell^{BB}$ (over $\ell = 135, 190, 255, 330$) of each small field for the model and NPIPE maps, and we present the results in scatter plots in Fig.~\ref{fig:smallfield_power_all}. It turns out that the amplitude of the \texttt{d12} model is in general smaller than the preference of NPIPE data, as a large fraction of the d12 data points cluster around the lower-left corner of the plot. The wider span of the \texttt{d12} data points along the vertical direction also implies the model spectrum steepness varies more over the sky. In contrast, the \texttt{d9}/\texttt{d10} data points are fairly compatible with the NPIPE results, although they predict slightly steeper power spectra. If we define the ratio of the low-$\ell$ mean value to the high-$\ell$ mean value as a proxy for describing the spatial power change across the modulation scale, while the perfect fixed-index power law $\mathcal{D}_\ell^{BB} \propto \ell^{-0.42}$ yields a value of $\approx 1.60$, the NPIPE maps give $1.65 \pm 0.68$ and the \texttt{d9}/\texttt{d10} (\texttt{d12}) model map gives $2.37 \pm 0.77$ ($2.24 \pm 0.87$) over sky patches with $|b| > 30^\circ$.

\begin{figure}
    \centering
    \includegraphics[width=0.48\textwidth]{figures/all2_lhmean.pdf}
    \caption{Scatter plots of the mean of the first two $BB$ band powers versus the mean of the last four $BB$ band powers shown in Fig.~\ref{fig:smallfield_power}. Each data point represents the results from a circular sky patches with $|b| > 30^\circ$. Dashed reference lines indicating $\mathcal{D}_\ell^{BB} \propto \ell^{-0.42}$ are added to the plots. This power law in fact comes from the analysis of several larger sky regions ($f_\text{sky} = 0.3 \; \text{to} \; 0.8$) by \cite{planck2014-XXX}, but the small-field NPIPE data points, which spread out when the dust amplitude is small presumably due to map noise, are consistent with it as well. Another important feature is that the trends of the \texttt{d9} and \texttt{d12} data points are lower than that of the NPIPE in these log-log plots, implying that the model spectra are steeper.}
    \label{fig:smallfield_power_all}
\end{figure}

\subsubsection{BICEP / Keck} \label{sec:bkspt_spectra}

\textbf{Ben:} The current upper limit on the tensor-to-scalar ratio is set by a combination of BICEP / Keck (BK), Planck, and WMAP data: $r < 0.036~(95\%)$ \citep{Ade:2021}. Over the next few years, a collaborative effort between the South Pole Telescope (SPT) and BICEP / Keck will combine high-resolution SPT-3G observations with BK observations in order to ``delens'' the observed CMB B-modes, and further constrain $r$. Therefore, there will be continued interest in simulating Galactic foregrounds on this particular patch of sky.

In Figure~\ref{fig:d1d9_bkpatch} we compare the BB power spectrum of the new \dnine{} model with the original PySM \done{} model, the GNILC input map, and the maximum likelihood dust model in this patch of sky determined from a combination of BK, Planck and WMAP data \citep{Ade:2021}. Model \done{} clearly has excess dust BB power compared to the measured amplitude in this patch of sky, which has been known for some time. This is somewhat ameliorated in model \dnine{}, primarily due to the steeper spectral tilt of the \dnine{} model leading to a factor of $\sim 10$ decrease in power relative to \done{} by multipoles of $\ell \gtrsim 300$. At larger scales of $\ell \lesssim 50$ both the \done{} and \dnine{} models are dominated by the underlying GNILC template, rather than the simulated small scale realizations, and so the mismatch in amplitude between the BK maximum likelihood model and our templates is most likely due to residual noise in the GNILC template. Indeed, most of the constraining power on dust BB power in Ref~\cite{Ade:2021} is driven by BK observations at 220\,GHz, which are not used to inform our model. 

One may argue that the amplitude and spectral tilt of the \dnine{} model clearly disagree with existing observations in the BK patch of sky. While this is true, it is beyond the scope of this work to provide full sky simulations that guarantee consistency with all sets of full sky and partial sky observations. Indeed, the use of power spectrum-based techniques requires a certain amount of global averaging of power spectrum parameters that are in fact known to vary across the sky \cite{planck2016-l04}. For example, while the dust amplitude can be modulated by the use of a large scale template, the spectral tilt has to be fixed to a single value for the full sky, which is not realistic. 

\begin{figure}[ht]
    \centering
    \includegraphics{paper_BK_patch.pdf}
    \caption{This figure shows the BB power spectra of the \done{} (crosses), \dnine{} (triangles), and varres GNILC map (circles), compared to the maximum likelihood BK dust model (black diamonds) derived from a combination of WMAP and Planck with BICEP / Keck data up to the 2018 observing season. Note that in order to make a meaningful comparison between the bandpowers calculated from maps and the theory curve, we first convolve the theory spectrum with the mode-coupling matrix and then compute the decoupled bandpowers by applying the inverted binned coupling matrix.}
    \label{fig:d1d9_bkpatch}
\end{figure}

\subsubsection{Map level validation}
%In this section, we present a map-level validation of the PySM dust models \dnine{}, {\tt d11}, {\tt d12} models against the Planck third data release (PR3) \cite{}.
\textbf{Elisa}: In this section, we compare at the map level, Planck third data release PR3 \cite{planck2016-l03}) and PySM dust models \dnine{}, {\tt d11}, {\tt d12} models. We study how well the modeled intensity $I$ and polarized intensity $P = \sqrt{U^2 + Q^2}$ match the observations on three selected $16.7^\circ \times 16.7^\circ$ patches of the sky, at different frequencies of 217~GHz, 353~GHz and 857~GHz. Here, we focus on two local patches: close to the Galactic plane ($[l,b] =[180^\circ,-10^\circ]$) and, centered on the Bicep / Keck field ($[l,b] =[318^\circ,-61^\circ]$).
Similar to Section~\ref{sec:sync_validation}, we integrate the dust models within the Planck passbands to enable direct comparison. For comparison of intensity maps, we subtract a Wiener-filtered CMB temperature anisotropies map from SMICA and adjust the zero level of the PR3 data to that of the simulated map over regions of faint dust intensity on the sky.
The mask used to adjust the zero levels is shown in figure \ref{fig:mask_zero_lvl_int}. These corrections are not required for comparing polarization data.
\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.48\textwidth]{figures/mask_intxPR3_zero_lvl.png}
    \caption{Mask $\times$ PR3 intensity used to estimate the zero level of PR3 intensity. This mask is obtained by thresholding the intensity of the smoothed PR3 intensity to preserve only the regions where the dust is very low, to estimate the zero-level of the data and models.}%more details
    \label{fig:mask_zero_lvl_int}
\end{figure}

\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.48\textwidth]{figures/gal_plane_non_smooth_wo_zero_lvl.png}
\caption{Dust intensity at 353GHz at [l = 180, b = -10] with an angular resolution of 4.41': (a) PR3 (b) d9 (c) d11 (d) d12}    
\label{fig:353_int_gal_plane}
\end{figure}
% \begin{figure}
%     \centering
%     \includegraphics[scale = 0.6]{figures/NGP_non_smooth_wo_zero_lvl.png}
%     \caption{Dust intensity at 353GHz centered at [l = 0, b = 90]: (a) PR3 (b) d9 (c) d11 (d) d12}
%     \label{fig:353_int_NP}
% \end{figure}
\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.48\textwidth]{figures/BK_non_smooth_wo_zero_lvl.png}
    \caption{Dust intensity at 353GHz at [l = 318, b = -61] with an angular resolution of 4.41': (a) PR3 (b) d9 (c) d11 (d) d12\\ Here, PR3 is contaminated by CIB and extragalactic sources.}
    \label{fig:353_int_BK}
\end{figure}

\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.48\textwidth]{figures/pol_gal_plane_smooth_30'.png}
    \caption{Polarized dust intensity at 353GHz centered at [l = 180, b = -10] with an angular resolution of 4.41', smoothed to 30 arcmin: (a) PR3 (b) d9 (c) d11 (d) d12.}
    \label{fig:353_pol_int_gal_plane}
\end{figure}
% \begin{figure}
%     \centering
%     \includegraphics[scale = 0.6]{figures/pol_NGP_smooth_30'.png}
%     \caption{Polarized dust intensity at 353GHz centered at [l = 0, b = 90].}
%     \label{fig:353_pol_int_NGP}
% \end{figure}

\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.48\textwidth]{figures/pol_BK_smooth_30'.png}
    \caption{Polarized dust intensity at 353GHz centered at [l = 318, b = -61] with an angular resolution of 4.41', smoothed to 30 arcmin: (a) PR3 (b) d9 (c) d11 (d) d12.}
    \label{fig:353_pol_int_BK}
\end{figure}

Intensity and polarization at 353~GHz are displayed in Figures~\ref{fig:353_int_gal_plane} to \ref{fig:353_pol_int_BK}. Varying choices for filtering the real data and generation of random small scales result in varying dust emission properties. For Intensity, d9 and d11 are very similar, with a loss of real structures, replaced by random realizations up to a scale of $l_{max} = 16384$, while d12 is more similar to the actual data. 
Around the Bicep / Keck patch center (Figure \ref{fig:353_int_BK}), the PR3 data is contaminated by the CIB, which masks out dust emission. 

For the polarized intensity, close to the Galactic plane (Figure \ref{fig:353_pol_int_gal_plane}), we see a resemblance between the data and the three models. In the North and South poles, noise dominates in PR3 without smoothing, so the comparison is made at a resolution of 30 arcmin. Overall, the agreement seems adequate between the models and the data considering the current level of uncertainties. 
%After smoothing with a Gaussian beam of 30 arcmin, we discern dust structures.


\subsubsection{Decorrelation} \label{sec:decorrelation}

In this section, we compare the decorrelation properties of various models, computed on the Galactic masks of the previous Section. The decorrelation parameter

\begin{equation}
    \mathcal{R}^{XY}_\ell(\nu_1\times\nu_2) = \frac{\mathcal{D}_\ell^{XY}(\nu_1\times\nu_2)}{\sqrt{\mathcal{D}_\ell^{XY}(\nu_1\times\nu_1)\mathcal{D}_\ell^{XY}(\nu_2\times\nu_2)}}
\end{equation}

Myra Norton's decorrelation plot to go here. Github: https://github.com/galsci/pysm/issues/123

\subsection{Extragalactic Contamination} \label{sec:CIBcontamination}

%[Stanford student Monica Hicks is working with Susan on cross-correlating our models with galaxy surveys a la Chiang \& Menard. Hopefully summary figure here.] 

\begin{figure}[h!]
    \centering
    \includegraphics[width=\columnwidth]{figures/EGC_galaxy@857Part_0-1.png}
    \caption{Relative extragalactic contamination in three of the new dust templates (\texttt{d10, d11, d12}), compared to the \texttt{d1} model. Contamination is quantified as the excess 857 GHz emission within $11'$ of galaxies from the GLADE+ catalog, normalized to the maximum excess and plotted as a function of redshift (z). All three new dust templates contain less extragalactic contamination than older dust models because they are based on GNILC-processed Planck data. The improvement is most significant for \texttt{d10} and \texttt{d11}.  }
    \label{fig:extragal_contamination}
\end{figure}


%Our Galactic dust templates are based on measurements of the 
We quantify the extragalactic contamination present in our dust models using a tomographic redshift-clustering technique \citep{Schmidt:2015, Chiang:2019}. Our intensity-based Galactic dust templates inevitably contain emission from both Galactic dust and external galaxies. As described in Section \ref{sec:dustamplitude}, the new \texttt{d9} and \texttt{d10} dust templates are derived from GNILC-processed Planck data, while older PySM dust templates used \texttt{Commander} data products. We thus expect that the new Galactic dust models are significantly less affected by CIB contamination than previous models. Here we quantify this contamination by measuring the angular cross-correlation between our dust models and the clustering of galaxies as a function of redshift in spectroscopic survey data. A perfect Galactic dust template would be uncorrelated with such clustering; the signature of CIB contamination is excess template emission correlated with galaxy clustering. 

Following the procedure in \citet{Chiang:2019}, we compute the cross-correlation between local fluctuations in the Galactic emission maps and the galaxy density as a function of redshift, using galaxies from the GLADE+ catalog \citep{Dalya:2022}. We compute this cross-correlation for each of the \texttt{d1, d10, d11}, and \texttt{d12} dust emission templates at 857 GHz, at high Galactic latitudes ($\left|b\right| > 30\deg$). Figure \ref{fig:extragal_contamination} shows that while each of the new GNILC-based maps contain less extragalactic contamination than \texttt{d1}, the decreased contamination is more marked in \texttt{d10} and \texttt{d11} than in \texttt{d12}. This is likely due to [FILTERING CHOICES? TO DISCUSS WITH JACQUES]


\subsection{Non-Gaussianity} \label{sec:nongaussianity}
writing: Yao + Nico

In this section, we focus on the thermal dust component and investigate the level of non-Gaussianity induced in the small scales generated through the polarization fraction tensor transformation, i.e., the simulations from PySM dust model \deleven{}. We use the Minkowski Functionals (MFs, \cite{Minkowski1903})  to measure the non-Gaussianity in the maps, which have long been used as estimators of non-Gaussianity.

According to Hadwiger’s theorem\citep{hadwigerVorlesungenUeberInhalt1957}, for any n-dimensional excursion set defined with a threshold value $\rho$, there exists $n+1$ kinds of MFs that geometrically and topologically describe the morphology of the set. Therfore, in our case, for the 2-dimensional maps, we have 3 kinds of MFs, $\mathcal{V}_0$, $\mathcal{V}_1$ and $\mathcal{V}_2$ which corresponds to the area, the length and the connectivity of the excursion set.

By comparing the MFs of the small scales structures from \deleven{} with those of Gaussian realizations from extrapolated power law, which is fitted from the power spectra of the maps from \deleven{}, in standard $IQU$ domain, we can have a qualitative estimation of non-Gaussianity in \deleven{} introduced by going into $iqu$ domain. As mentioned in Section \ref{subsec:methodology}, the generated small scales in the \deleven{} model are modulated before adding to the large scales. To study the potential effect of anisotropy on the non-Gaussianity, we also generate Gaussian realizations with modulation so that we can compare the non-Gaussianity directly, without the influence of anisotropy. The two reference sets made of pure Gaussian small scales and modulated Gaussian small scales are built as follows:

\begin{enumerate}

\item We first fit power laws to the $TT$, $EE$, $BB$ power spectra in the multipole range $[800, 2000]$ calculated from the full sky maps output by \deleven{}, and extrapolate them up to $\ell_{\rm max}=4096$. 
\item To obtain only the small scales, we apply a high-pass filter to the fitted power law with $\ell_{cut} = 200$ for intensity and polarization maps, and then generate full sky small scales realizations using \texttt{synfast} routine provided by \texttt{HEALPix}. 
\item For modulated Gaussian maps, these full-sky small scales are then multiplied with modulation maps to have similar anisotropies with the small scales from \deleven{}. While for pure Gaussian maps, we do not apply modulations. 
\item Meanwhile, the small scales with multipoles larger than 200 in the observed data are filtered out and the large scales remain untouched.
\item At last, the generated Gaussian small scales are added into observed large scales to form the final set of maps. 
\end{enumerate}

Now we have three sets of maps with different small scales co-added: one from \deleven{}, one from pure Gaussian and the last from modulated Gaussian realization in the $IQU$ domain. We then apply a high-pass filter to retain only the small scales of these maps, that we call \texttt{poltens-ss}, \texttt{Gaussian-mod-ss}, and \texttt{Gaussian-ss} respectively. To calculate the MFs we select several patches on the sky and project them onto flat plane. Note that the design of the modulation maps is to ensure the final \texttt{Gaussian-mod-ss} maps have the same anisotropy as \texttt{poltens-ss}, which is done by tuning the modulation maps to let \texttt{Gaussian-mod-ss} have the same power spectra behavior as \texttt{poltens-ss} on different masks that exclude the inner part of the Galactic plane. \texttt{Gaussian-ss} are thought to be fully Gaussian and isotropic. 

Below we show the MFs calculated for these three sets of small scales on the sphere and also for a selected flat patch.

\subsubsection{MFs on the sphere}

Following the algorithm in \cite{2022OJAp....5E..13G}, we calculate the MFs for the three Q maps on the sphere, i.e. \texttt{HEALPix} format, with a Planck HFI 80\% sky mask \footnote{\url{http://pla.esac.esa.int/pla/aio/product-action?MAP.MAP_ID=HFI_Mask_GalPlane-apo2_2048_R2.00.fits}}, which masks out the complex Galactic plane.  Before the calculation we first normalize the maps by dividing each map by its standard deviation separately and choose [-3, 3] as the threshold range to calclate the MFs. Results are shown in Figure.~\ref{fig:MF:sphere}, where the first, second and third kind of MFs are shown from left to right.(MFs of U maps look like very similar to Q maps and are not shown here). 

We can see that when averaging for large sky fraction, the MFs of \texttt{Gaussian-mod-ss} in blue and \texttt{poltens-ss} in orange are almost the same, while MFs of \texttt{Gaussian-ss} differ a lot in dashed gray color. The difference in MFs between \texttt{poltens-ss} and \texttt{Gaussian-ss} means the existence of non-Gaussianity in \texttt{poltens-ss}, but the similarity between \texttt{poltens-ss} and \texttt{Gaussian-mod-ss} proves that the non-Gaussianity in \texttt{poltens-ss} comes from the anisotropy in the maps, which originates from the modulation, rather than from the polarization fraction tensor transformation.   

\begin{figure*}[hbt!]
    \centering
    \includegraphics[width=180mm]{figures/MFs_80p_sky_Q.pdf}
    \caption{MFs for the small scales of three sets of maps on the sphere with Planck HFI 80\% mask. The small scales are filtered out by excluding multipoles smaller than 200 in the maps and we choose $lmax = 2048$ when obaining the small scales. We show the MFs as a function of threshold $\rho$, for \texttt{Gaussian-mod-ss} in blue, \texttt{poltens-ss} in orange and  \texttt{Gaussian-ss} in dashed gray.}
    \label{fig:MF:sphere}
\end{figure*}


\subsubsection{MFs on the flat patch}
In this section we zoom into a specific region centered at [$-15^{\circ}$ , $45^{\circ} $] with dimension of $20^{\circ}\times20^{\circ}$ to see if, by looking at smaller regions of the sky, we can measure a significance difference in the MFs between \texttt{Gaussian-mod-ss} and \texttt{poltens-ss} sets of maps. Those maps are shown the third and fourth column in Figure~\ref{fig:maps:patch2} respectively, with the Gaussian modulated and \deleven{} full resolution maps including both large and small scales shown in the first and second column. Here we consider I, Q and U maps which are shown from upper to lower panel. When zooming into this patch, we can see by eye that \texttt{poltens-ss} have some structures, following those in the full resolution maps, which are not present in the \texttt{Gaussian-mod-ss} maps. Again we calculate the MFs of these small scales to have an understanding of the non-Gaussianities, following \cite{2008JSMTE..12..015M} for the calculation of MFs for a square patch. Before the calculation, we also rescale all the small scales to be in the range [-1, 1].

Figure~\ref{fig:MF:patch2} shows the MFs of the \texttt{Gaussian-mod-ss} and \texttt{poltens-ss} maps presented in Figure.~\ref{fig:maps:patch2} as blue and orange lines respectively, while MFs for \texttt{Gaussian-ss} are shown in dashed gray lines. 
Contrary to the results presented in Figure \ref{fig:MF:sphere}, in this case we can detect a departure of the \texttt{poltens-ss} from the \texttt{Gaussian-mod-ss} ones. This points towards the fact that the polarization fraction tensor transformation may induced some level of non-Gaussianity, different from pure modulation effects, which are detectable on small sky regions. We can thus conclude that the level of induced non-Gaussianity differs from one region to the other and it is in general small enough not to impact significantly the statistical properties when averaged on large sky fraction.  

\begin{figure*}[hbt]
    \centering
    \includegraphics[width=180mm]{figures/maps_patch_345_35.pdf}
    \caption{The zoom-in plot of the maps, in the selected patch with center [$-15^{\circ}$ , $45^{\circ} $]. From left to right, we show the final map with \texttt{Gaussian-mod-ss}, final map with \texttt{poltens-ss}, \texttt{Gaussian-mod-ss} only map and \texttt{poltens-ss} only map. From top to bottom is for I, Q and U respectively. The colorbar on the left indicates the pixel values in the left-most two columns in the units of $\mu K_{RJ}$ and the colorbar on the right is for the last two columns. }
    \label{fig:maps:patch2}
\end{figure*}
\begin{figure*}[hbt]
    \centering
    \includegraphics[width=180mm]{figures/MFs_345_45_with_G_rescaled.pdf}
    \caption{Minkowski Functionals as a function of the threshold $\rho$ for the one realization of I, Q and U small scales in the patch with center of [$-15^{\circ}$ , $45^{\circ} $] in Galactic coordinates. Each row shows three kinds of Minkowski Functionals. The blue dotted one is for \texttt{Gaussian-mod-ss} while the orange solid one is from \texttt{poltens-ss}. We also show the \texttt{Gaussian-ss} in dashed gray line as a comparison.}
    \label{fig:MF:patch2}
\end{figure*}


\section{Model Suite}\label{sec:modelsuite}
Writing: Susan + others
\begin{table*}[]
    \centering
    \begin{tabular}{lcc}
    
    \toprule 
    Complexity & Model set & Short description \\
    \midrule
    Low  & \texttt{d9, s4, f1, a1, co1} & sdf  \\
    Medium  & \texttt{d10, s5, f1, a1, co3} & sdf   \\
    High  & \texttt{d12, s7, f1, a2, co3} & MKD dust layer model, spatially varying synchrotron curvature, polarized AME  \\
   
   \bottomrule
    \end{tabular}
    \caption{Summary of the suite of model sets described in Section \ref{sec:modelsuite}. These are recommended combinations of models at three levels of complexity (low, medium, and high).  }
    \label{tab:modelsuite}
\end{table*}

The models available for each emission component can be used in various combinations to form a number of unique Galactic sky models. While every user has this combinatoric freedom, we also prescribe a suite of recommended model sets. Table \ref{tab:modelsuite} details three model sets, representing increasing levels of complexity. The low complexity model set is highly idealized.
The medium complexity model set includes Galactic emission properties that are both expected physically and confirmed observationally, like ..
The high complexity model set models Galactic emission properties that are physically realistic but as-yet undetected, like polarized AME and spatially varying synchrotron curvature. The high complexity model set uses the MKD layer model for Galactic dust emission, and the decorrelation is near the maximum allowed by current constraints.  

%Susan: Either here or before validation, we should have a succinct section that lays out the 3 complexity levels

[Moved from intro, work this in here:]
for example analyzing CMB-S4 data together with that of the precursor South Pole and/or Simons Observatories, or using CMB-S4 high resolution data to help delens LiteBIRD and LiteBIRD high frequency data to help remove dust from CMB-S4.


\section{Discussion} \label{sec:discussion}
writing: Susan + others

\begin{enumerate}
    \item Highlight improvements made and why they are relevant to various CMB science cases
    \item Identify areas where algorithms can be improved (notably modulation of small scales, non-trivial TB/EB correlations)
\end{enumerate}

Susan:
One area for future development is in the implementation of parity-odd polarization quantities ($TB$, $EB$), or effects that give rise to them. The \textit{Planck} 353 GHz data show a positive $TB$ correlation over large angular scales (cite Planck++), and (misalignment, cite Clark/Huffenberger/Cukierman, state importance for CB++)


\section{Summary and Conclusions} \label{sec:summary}

We have done X. The principal conclusions of this work are as follows:

\begin{enumerate}
    \item Some nice bullets here
\end{enumerate}

Short forward-looking paragraph.

\bibliography{refs.bib,refsADS.bib,refsPlanck.bib}

\end{document}
